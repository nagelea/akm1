# Azure OpenAI 数据处理指南

由于Azure OpenAI密钥的特殊性（32位字符，与很多哈希值格式相似），导致假阳性率很高。本指南提供了分析、重新处理和清理工具。

## 🆕 推荐：智能重新处理（推荐使用）

```bash
npm run reprocess:azure
```

这是最安全的方法，会：
- ✅ 重新检测所有可能的密钥类型
- 🔄 自动重新分类错误归类的密钥
- ✅ 保留有效的Azure OpenAI密钥  
- 🗑️ 只删除真正的假阳性
- 💾 **最大程度避免数据丢失**

## 🔍 步骤1：分析现有数据

首先运行分析脚本，了解假阳性情况：

```bash
npm run analyze:azure
```

这个脚本会：
- ✅ 分析所有现有的Azure OpenAI记录
- 📊 生成详细的统计报告
- 🔍 识别假阳性的具体原因
- 💾 保存详细报告到 `azure-openai-analysis-report.json`
- ⚠️ **不会删除任何数据**，只做分析

## 📊 分析报告内容

分析脚本会检查每个密钥是否满足以下条件：

### ✅ 有效密钥条件
1. **格式正确**：32位十六进制字符 `[a-f0-9]{32}`
2. **上下文要求**：同时包含 `azure` 和 `openai` 关键词
3. **不在注释中**：不在代码注释里 (`//`, `#`, `/* */`)
4. **不是哈希值**：上下文中没有hash/git/commit等关键词
5. **排除误判**：不包含github/uuid/token等排除关键词

### ❌ 假阳性分类
- **📝 注释中的密钥**：在代码注释中的示例
- **🔗 哈希值类型**：Git commit哈希、MD5等
- **📄 上下文不足**：缺少azure或openai关键词
- **🚫 排除的上下文**：包含排除关键词
- **❌ 格式无效**：不是32位十六进制

## 🔄 步骤2：智能重新处理（推荐）

```bash
npm run reprocess:azure
```

这个脚本会安全地处理所有Azure OpenAI记录：

### 📋 处理流程
1. **重新检测**: 在原始上下文中重新检测所有可能的密钥类型
2. **按置信度排序**: 优先选择高置信度的匹配
3. **智能分类**: 
   - 🔄 OpenRouter密钥 → 重新分类为`openrouter`
   - 🔄 OpenAI密钥 → 重新分类为`openai`
   - 🔄 其他API密钥 → 重新分类为对应类型
   - ✅ 有效Azure OpenAI → 保留
   - 🗑️ 真正假阳性 → 删除

### 💾 数据保护
- **重新分类** 而不是删除错误归类的密钥
- **保留** 真正的Azure OpenAI密钥
- **挽救** 被错误分类的其他API密钥

## 🧹 步骤3：传统清理（仅删除，不推荐）

⚠️ **注意：此操作只会删除数据，可能丢失有效密钥！**

如果确定只想删除假阳性：

```bash
npm run cleanup:azure
```

## 📈 预期效果

### 🔄 智能重新处理效果
- **数据挽救率**: 70-90% (重新分类 + 保留有效)
- **OpenRouter密钥**: 自动重新分类为`openrouter`
- **OpenAI密钥**: 自动重新分类为`openai`  
- **Azure OpenAI**: 只保留真正有效的
- **假阳性删除**: 只删除确认的假阳性

### 🧹 传统清理效果
- **之前**：假阳性率可能 > 80%
- **之后**：假阳性率应该 < 20%
- **风险**：可能误删有效密钥

## 🛡️ 安全建议

1. **备份数据**：处理前务必备份数据库
2. **先分析**：始终先运行 `analyze:azure` 查看报告
3. **优先重新处理**：推荐使用 `reprocess:azure` 而不是 `cleanup:azure`
4. **验证结果**：处理后检查重新分类的记录

## 🔧 高级配置

如果需要调整验证规则，可以修改 `scripts/analyze-azure-openai.js` 中的：

```javascript
// 排除关键词列表
const excludeKeywords = ['github', 'git', 'commit', 'hash', 'sha', 'md5', 'token', 'uuid', 'id'];

// 哈希指示器
const hashIndicators = [
  'commit', 'hash', 'sha', 'md5', 'checksum', 'digest',
  'git', 'github', 'gitlab', 'repository', 'version',
  'uuid', 'guid', 'identifier', 'token_id'
];
```

## 📝 示例输出

```
📊 Azure OpenAI 密钥分析报告
================================================================================
📈 总计密钥: 1845
✅ 有效密钥: 123 (6.7%)
❌ 假阳性: 1722 (93.3%)

📋 假阳性分类:
   🔗 哈希值类型: 856 个
   📝 注释中的密钥: 432 个  
   📄 上下文不足: 298 个
   🚫 排除的上下文: 136 个

💡 建议:
   - 假阳性率很高，建议执行清理脚本删除假阳性记录
   - 运行: npm run cleanup:azure
```

## ⚠️ 重要提醒

- 清理是**不可逆**操作
- 建议在测试环境先验证
- 有疑问的记录可以手动检查
- 清理后重新扫描时会应用新的严格规则