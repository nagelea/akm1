# æ•°æ®åº“å¤‡ä»½å®Œæ•´æ€§æŒ‡å—

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

æ ¹æ® `database-simple.sql`ï¼Œç³»ç»ŸåŒ…å«ä»¥ä¸‹æ‰€æœ‰è¡¨ï¼š

### ğŸ” æ ¸å¿ƒæ•°æ®è¡¨
| è¡¨å | ç”¨é€” | å¤‡ä»½çŠ¶æ€ | é‡è¦æ€§ |
|------|------|----------|--------|
| `leaked_keys` | å…¬å¼€å¯†é’¥ä¿¡æ¯ | âœ… å·²å¤‡ä»½ | é«˜ |
| `leaked_keys_sensitive` | å®Œæ•´å¯†é’¥æ•°æ® | âœ… å·²å¤‡ä»½ | æé«˜ |
| `admin_users` | ç®¡ç†å‘˜è´¦æˆ· | âœ… å·²å¤‡ä»½ | é«˜ |
| `access_logs` | æ“ä½œå®¡è®¡æ—¥å¿— | âœ… å·²å¤‡ä»½ | ä¸­ |
| `daily_stats` | æ¯æ—¥ç»Ÿè®¡æ•°æ® | âœ… å·²å¤‡ä»½ | ä¸­ |

### ğŸ“ˆ æ–°å¢è¡¨ï¼ˆå¯é€‰ï¼‰
| è¡¨å | ç”¨é€” | å¤‡ä»½çŠ¶æ€ | é‡è¦æ€§ |
|------|------|----------|--------|
| `backup_history` | å¤‡ä»½å†å²è®°å½• | ğŸ”„ è‡ªåŠ¨æ£€æµ‹ | ä½ |

### ğŸ” æ•°æ®åº“å¯¹è±¡
| å¯¹è±¡ç±»å‹ | åç§° | å¤‡ä»½æ–¹å¼ |
|----------|------|----------|
| è§†å›¾ | `recent_keys` | ğŸ“„ ä¸å¤‡ä»½ï¼ˆå¯é‡å»ºï¼‰ |
| è§†å›¾ | `stats_summary` | ğŸ“„ ä¸å¤‡ä»½ï¼ˆå¯é‡å»ºï¼‰ |
| è§†å›¾ | `backup_stats` | ğŸ“„ ä¸å¤‡ä»½ï¼ˆå¯é‡å»ºï¼‰ |
| å‡½æ•° | `get_user_tables()` | ğŸ“„ è„šæœ¬é‡å»º |
| è§¦å‘å™¨ | `update_*_updated_at` | ğŸ“„ è„šæœ¬é‡å»º |
| ç´¢å¼• | å„ç§ç´¢å¼• | ğŸ“„ è„šæœ¬é‡å»º |
| RLSç­–ç•¥ | æƒé™æ§åˆ¶ | ğŸ“„ è„šæœ¬é‡å»º |

## ğŸ”§ å¤‡ä»½æ–¹æ³•å¯¹æ¯”

### 1. æ ‡å‡†å¤‡ä»½ï¼ˆGitHub Actionsï¼‰
```yaml
# .github/workflows/database-backup.yml
tables: ['leaked_keys', 'leaked_keys_sensitive', 'admin_users', 'access_logs', 'daily_stats']
```
- âœ… è¦†ç›–æ‰€æœ‰æ ¸å¿ƒè¡¨
- âœ… è‡ªåŠ¨åŠ å¯†
- âœ… å®šæ—¶æ‰§è¡Œ
- âŒ å›ºå®šè¡¨åˆ—è¡¨

### 2. æ™ºèƒ½å¤‡ä»½ï¼ˆæ¨èï¼‰
```bash
npm run backup:intelligent
```
- âœ… è‡ªåŠ¨å‘ç°æ‰€æœ‰è¡¨
- âœ… åŒ…å«è¡¨ç»Ÿè®¡ä¿¡æ¯
- âœ… é”™è¯¯å®¹é”™å¤„ç†
- âœ… è¯¦ç»†å¤‡ä»½æŠ¥å‘Š
- âŒ éœ€è¦é¢å¤–è®¾ç½®

### 3. æµ‹è¯•å¤‡ä»½
```bash
npm run test:backup
```
- âœ… éªŒè¯è¿æ¥æ€§
- âœ… æ£€æŸ¥è¡¨å­˜åœ¨æ€§
- âœ… ç»Ÿè®¡è®°å½•æ•°é‡
- âŒ ä¸ç”Ÿæˆå®é™…å¤‡ä»½

## ğŸ“‹ å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥æ¸…å•

### âœ… å½“å‰å¤‡ä»½çŠ¶æ€
- [x] `leaked_keys` - æ ¸å¿ƒå¯†é’¥æ•°æ®
- [x] `leaked_keys_sensitive` - å®Œæ•´å¯†é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
- [x] `admin_users` - ç®¡ç†å‘˜è´¦æˆ·
- [x] `access_logs` - å®¡è®¡æ—¥å¿—
- [x] `daily_stats` - ç»Ÿè®¡æ•°æ®

### ğŸ”„ è‡ªåŠ¨åŒ–æ£€æŸ¥
```bash
# éªŒè¯å¤‡ä»½å®Œæ•´æ€§
npm run test:backup

# ç”Ÿæˆæ™ºèƒ½å¤‡ä»½
npm run backup:intelligent

# æ£€æŸ¥è¡¨ç»“æ„å˜åŒ–
npm run backup:intelligent | grep "å‘ç°.*ä¸ªè¡¨"
```

## ğŸš€ è®¾ç½®æ™ºèƒ½å¤‡ä»½

### 1. æ‰§è¡Œæ•°æ®åº“å‡½æ•°è®¾ç½®
åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­æ‰§è¡Œï¼š
```sql
-- å¤åˆ¶å¹¶æ‰§è¡Œ setup-backup-functions.sql ä¸­çš„å†…å®¹
```

### 2. éªŒè¯å‡½æ•°å¯ç”¨æ€§
```bash
npm run test:backup
```

### 3. æ›´æ–° GitHub Actionsï¼ˆå¯é€‰ï¼‰
```yaml
# åœ¨ .github/workflows/database-backup.yml ä¸­æ›¿æ¢ï¼š
node backup_script.js "$BACKUP_FILE"
# ä¸ºï¼š
node scripts/intelligent-backup.js "$BACKUP_FILE"
```

## ğŸ“Š å¤‡ä»½æ•°æ®ç»“æ„

### æ ‡å‡†å¤‡ä»½æ ¼å¼
```json
{
  "leaked_keys": [...],
  "leaked_keys_sensitive": [...],
  "admin_users": [...],
  "access_logs": [...],
  "daily_stats": [...],
  "_metadata": {
    "timestamp": "2024-12-27T04:21:21.000Z",
    "version": "2.0.0",
    "tables": ["leaked_keys", "..."],
    "total_records": 1234
  }
}
```

### æ™ºèƒ½å¤‡ä»½æ ¼å¼
```json
{
  "table_name": [...],
  "_metadata": {
    "backup_type": "intelligent_full",
    "tables_discovered": ["..."],
    "successful_tables": ["..."],
    "failed_tables": ["..."],
    "schema_info": {
      "discovery_method": "automatic",
      "table_count": 5
    }
  }
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ•°æ®å®‰å…¨
- ğŸ”’ æ•æ„Ÿè¡¨ (`leaked_keys_sensitive`) åŒ…å«å®Œæ•´APIå¯†é’¥
- ğŸ”’ ç®¡ç†å‘˜è¡¨ (`admin_users`) åŒ…å«å¯†ç å“ˆå¸Œ
- ğŸ”’ æ‰€æœ‰å¤‡ä»½éƒ½åº”åŠ å¯†å­˜å‚¨

### å¤‡ä»½ç­–ç•¥
- ğŸ“… æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ï¼ˆGitHub Actionsï¼‰
- ğŸ’¾ æœ¬åœ°ä¿ç•™7å¤©åŠ å¯†å¤‡ä»½
- ğŸ”„ æ™ºèƒ½å¤‡ä»½ç”¨äºå®Œæ•´æ€§éªŒè¯
- ğŸ“Š å¤‡ä»½å†å²è®°å½•å¯é€‰è·Ÿè¸ª

### æ¢å¤è€ƒè™‘
- ğŸ”§ ç»“æ„æ¢å¤ï¼šå…ˆæ‰§è¡Œ `database-simple.sql`
- ğŸ“Š æ•°æ®æ¢å¤ï¼šä½¿ç”¨ `npm run restore:backup`
- âš¡ éƒ¨åˆ†æ¢å¤ï¼šæ”¯æŒå•è¡¨æ¢å¤
- ğŸ” éªŒè¯æ¢å¤ï¼šä½¿ç”¨ `npm run test:backup`

## ğŸ› ï¸ æ•…éšœæ’é™¤

### è¡¨ä¸å­˜åœ¨é”™è¯¯
```
Error backing up table_name: relation "public.table_name" does not exist
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `database-simple.sql` æ˜¯å¦å·²æ‰§è¡Œ
2. éªŒè¯è¡¨åæ‹¼å†™
3. ç¡®è®¤RLSç­–ç•¥å…è®¸è®¿é—®

### æƒé™é”™è¯¯
```
Error: insufficient_privilege
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®è®¤ä½¿ç”¨ `SUPABASE_SERVICE_KEY`
2. æ£€æŸ¥RLSç­–ç•¥é…ç½®
3. éªŒè¯æœåŠ¡è§’è‰²æƒé™

### ç©ºå¤‡ä»½æ–‡ä»¶
```
Backup saved but contains no data
```
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è¿è¡Œ `npm run test:backup` è¯Šæ–­
2. æ£€æŸ¥è¡¨ä¸­æ˜¯å¦æœ‰æ•°æ®
3. éªŒè¯Supabaseè¿æ¥